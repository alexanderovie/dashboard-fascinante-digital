name: Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security audit weekly (every Monday at 9 AM UTC)
    - cron: '0 9 * * 1'

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Run npm audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  lint-security:
    name: Security Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # TODO: Revert continue-on-error once lint is CI-stable.
      - name: Run ESLint with security rules
        run: pnpm lint
        continue-on-error: true

      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  auth-tests:
    name: Authentication Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect auth tests
        id: auth_tests
        run: |
          if [ -d "src/lib/auth/__tests__" ]; then
            echo "run_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run auth unit tests
        if: steps.auth_tests.outputs.run_tests == 'true'
        run: pnpm test src/lib/auth/__tests__

      - name: Check test coverage
        if: steps.auth_tests.outputs.run_tests == 'true'
        run: pnpm test:coverage

      # TODO: Re-enable strict coverage upload when Codecov token is configured.
      - name: Upload coverage to Codecov
        if: steps.auth_tests.outputs.run_tests == 'true' && secrets.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./coverage/coverage-final.json
          flags: auth
          fail_ci_if_error: false

  docker-scan:
    name: Docker Image Scan
    runs-on: ubuntu-latest
    # Disabled: Vercel deploys without Docker. Re-enable when containerized.
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dashboard-fascinante:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'dashboard-fascinante:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  security-headers:
    name: Validate Security Headers
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @lhci/cli

      - name: Check middleware security headers
        run: |
          echo "Validating middleware.ts for security headers..."
          if ! grep -q "Strict-Transport-Security" middleware.ts; then
            echo "ERROR: Missing HSTS header"
            exit 1
          fi
          if ! grep -q "X-Frame-Options" middleware.ts; then
            echo "ERROR: Missing X-Frame-Options header"
            exit 1
          fi
          echo "âœ“ Security headers validated"

  notify:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: [dependency-audit, lint-security, auth-tests, docker-scan]
    # Only notify when Slack webhook is configured.
    if: failure() && secrets.SLACK_WEBHOOK_URL != ''

    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'ðŸš¨ Security audit failed! Check the logs.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
